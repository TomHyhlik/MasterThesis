\chapter{Návrh WSN}
\label{Návrh WSN}
Tato kapitola popisuje návrh řešení rozšíření přístupového sytému o senzorovou síť.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Návrh integrace WSN gatewaye do stávající infrastruktury přístupového systému}
\label{Implementace WSN do přístupového systému}
Přístupový systém k rozšíření o WSN je vytvořen firmou IMA a je komerčně distribuován. Jeho architektura se liší od všeobecné architektury zobrazené v blokovém schematu \ref{fig:Access control system architecture} přidáním zařízení CKP, tvořícího rozhraní mezi kontrolním panelem a čtečkou s dveřním zámkem. Přístupový systém má několik typů CKP zařízení podporujících různé typy čteček, dveřních zámků, závor, vrat a podobně, ale všechna tato CKP zařízení podporují CKP protokol v síti RS485 pro komunikaci s kontrolním panelem.

Rozšíření tohoto Přístupového systému o WSN je vytvořeno připojením WSN gatewaye ke kontrolnímu panelu přes RS485 síť stejně jako CKP zařízení. Názorná blokové schéma přístupového systému firmy IMA s implementací WSN gatewaye je zobrazeno v obrázku \ref{fig:ACS architecture IMA with geteway}.
V budovách, kde již je tento přístupový systém nainstalován je obvykle více kontrolních panelů, vždy jeden kontrolní panel pro několik dveří s CKP zařízeními propojenými sítí RS485. 
K jednomu přístupovému systému je možné připojit několik WSN gatewayí k libovolným kontrolním panelům v budově pro dosažení požadovaného pokrytí WSN.

\begin{figure}[!h]
\centering
\includegraphics[width=1\textwidth]{ACS_IoT_extension_21}
\caption{IMA access control system architecture with WSN extension}
\label{fig:ACS architecture IMA with geteway}
\end{figure}


WSN gateway tedy musí podporovat CKP protokol v sítí RS485 navržen firmou IMA.
Přístupový systém firmy IMA funguje tak, že CKP zařízení získává seznam všech platných karet (ID Credentials) ze serveru řízení přístupu a na základě tohoto seznamu pak CKP zařízení provádí odpovídající akci po přiložení karty ke čtečce. 
Je-li ke čtečce přiložena karta, jejíž číslo není obsaženo v seznamu platných karet, CKP zařízení pouze signalizuje událost uživateli (např. červené bliknutí nebo pípnutí), ale zprávu o této události neodesílá na server řízení přístupu. Je-li ke čtečce přiložena karta, jejíž číslo je obsaženo v seznamu platných karet, CKP zařízení signalizuje událost uživateli (např. zelené bliknutí nebo pípnutí) a zprávu o této události odesílá na server řízení přístupu příkazem tzv. "průchod".
Navržená gateway bere seznam platných karet jako seznam platných koncových zařízení senzorové sítě. Gateway pak zpracovává pakety pouze od zařízení z tohoto seznamu a ostatní ignoruje, tudíž v síti RS485 jsou přenášena pouze relevantní data.
Data z koncových zařízení jsou odesílána na server řízení přístupu příkazem "průchod", který má fixní velikost a po přidání adresy koncového zařízení o velikosti 4 B zde už zbývá pouze 6 B pro data z koncového zařízení, což je velké omezení.
%Since the CKP protocol allows to transmit fixed-size command with only 10 bytes of space, the first 4 bytes are LoRaWAN device address of the node from which the paket was received and the 6 remaining bytes are used for the node data.
LoRaWAN protokol používá paket, jehož samotná hlavička je o minimální velikosti 13 B. 
Různá LoRaWAN koncová zařízení používají různé velikosti datového obsahu (payloadu), takže není možné odesílat celý payload koncového zařízení přes síť RS485.
Tento problém je řešen ta, že LoRaWAN pakety z koncových zařízení jsou dešifrovány přímo v gatewayi a konečné hodnoty senzorů jsou vypočítány z payloadu zařízení na základě dokumentace poskytnuté výrobcem \cite{RHF1S001 pdf}. Vybrané hodnoty jsou odeslány na server řízení přístupu skrze kontrolní panel. 
% In summary, when the Gateway receives an encrypted LoRaWAN paket, it looks for whether the Node device address is in the list of known device addresses.
% If this is the case, the paket is encoded in the communication protocol of the Gateway and sent to the Control Panel. If there is not enough space in communication protocol of the Gateway, the paket is decrypted and relevant data, i.e., sensor values, are selected.

% When the user presents his card to the Reader and the card ID matches one of the valid cards, the CKP device sends the data to the Access Control Server.
% The same procedure applies to the Gateway.
% When the Gateway receives data from a Node and the Node address matches one of the valid device address list, the Gateway sends the data to the Access Control Server.

    

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{Návrh WSN gatewaye}
% Jak již bylo zmíňeno v předchozí sekci, gateway dešifruje pakety z koncových zařízení a na základě typu koncového zařízení vypočítává z datového obsahu (payloadu) hodnoty senzorů z nichž vybrané odesílá na server řízení přístupu přes kontolní panel a to z důvodu datového omezení protokolu v síti RS485, do které je gateway připojena.
Pro každý podporovaný typ koncového zařízení musí být implementováno zpracování datového obsahu (payloadu) ve FW (FW) gatewaye. Pozdější přidání typů koncových zařízení tedy vyžaduje update FW gatewaye.
Gateway tedy má uloženou informaci o typu koncového zařízení společně s jeho LoRaWAN device address.
%% todo, cast teto vet uz je v predchozi kapitole
LoRaWAN protokol je zabezpečen šifrováním AES-128 na dva způsoby, a to zabezpečení aplikační pro nečitelnst přenášených dat a síťové pro zabránění útočníkům opakovat již přenesené pakety nebo odesílat falešné pakety. Jsou zde tedy dva AES-128 šifrovací klíče, applikační klič AppSKey (Application Session Key) a síťový klíč NwKSKey (Network Session Key).

Jelikož adresy koncových zařízení jsou předávány gatewayi stejně jako platné karty čtečce z aplikace na serveru řízení přístupu, není zde možnost předávat dva 16 B dlouhé šifrovací klíče pro každé koncové zařízení společně s adresou zařízení. Geteway tedy má tyto dva klíče pro všechna zařízení stejné, uložené v non-volatile paměti, konfigurovatelné pouze přímo na gatewayi.
% LoRaWAN device address a typ každého zařízení v síti je uložena v non-volatile paměti gatewaye a jsou nastavována na z access control serveru.
% Pro tento vybraný případ byla vyvinuta knihovna pro dekódování payloadu na základě dokumentů \cite{lwSpec} \cite{lwSecur}.
V tomto návrhu není implementován opačný směr komunikace, tedy ze serveru řízení přístupu na koncové zařízení, ale je také možné implementovat pro ovládání aktuátorů, jako je relé, motor, apod.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Protokol CKP v síti RS485 pro komunikaci s kontrolním panelem}
CKP protokol v sítí RS485 pro komunikaci s kontrolním panelem je kolizní protokol, kde všechna zařízení se řídí pravidlem LBT (Listen Before Talk), kolize jsou detekovány mechanismem kontroly integrity použitý v každém příkazu. V případě že zařízení přijme poškozený příkaz, vyžádá jeho opakování. 
V této síti je jedno zařízení typu master, a jedno nebo více zařízení typu slave, přičemž zařízení typu master je kontrolní panel a zařízení typu slave je jakékoliv CKP zařízení, v tomto vybraném případě gateway.
Každé zařízení má svoji adresu definovanou jedním bytem, která musí být unikátní pro jednu síť a každý příkaz v této síti obsahuje v hlavičce adresu odesílatele a adresu příjemce.
Zařízení typu slave má dva možné statusy, offline a online, periodický odesílá příkaz s informací o jeho aktuálním statusu, má povoleno odesílat příkaz s daty z koncového zařízení senzorové sítě "průchod" pouze má-li status online a změnu statusu daného zařízení typu slave provádí zařízení typu master. 
Zařízení typu slave svůj status změní samo z online na offline v případě, že zařízení typu master přestane odpovídat na příkaz "průchod".

Je-li CKP zařízení spuštěno, má status offline a periodicky odesílá příkaz s informaci o jeho statusu na kontrolní panel, který po obdržení tohoto příkazu předá seznam adres koncových zařízení senzorové sítě sekvencí několika příkazů a pak ho přepne do statusu online. V této chvíli již gateway přeposílá data z koncových zařízení senzorové sítě na kontrolní panel.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Sestavení HW k vytvoření prototypu gatewaye k testování}
Pro otestování navrženého řešení rozšíření přístupového systému o senzorovou síť je sestavena gateway z vývojového kitu NUCLEO-L073RZ \cite{nucleoST}, transceiveru Dragino LoRa Shield \cite{RFM95w} a RS485 transceiver \cite{rs485tr}, viz. obr. \ref{fig:gatewayBlockDiagram}.

\begin{figure}[!h]
    \centering
    \includegraphics[width=1\textwidth]{LoRaWAN_gw_RS485_blockDiagram_2}
    \caption{Gateway block diagram, RFM95w \cite{RFM95w}, RS485 transceiver \cite{rs485tr}, NUCLEO-L073RZ \cite{nucleoST}}
    \label{fig:gatewayBlockDiagram}
\end{figure}

Vývojový kit NUCLEO-L073RZ s integrovaným mikrokontrolérem STM32L073RZ je vhodný pro vývoj kvůli jeho parametrům viz tabulka \ref{tab:mcuFeatures}, pinoutu kompatibilním s Arduino UNO, dokumentaci a ceně (\$13 USD \cite{nucleoST}). 
K vytvoření prototypu byl použit, protože splňuje všechny požadované parametry, je levný, dostatečně výkonný a jednoduchý pro vývoj. Kit obsahuje programátor ST-link pro nahrávání a debugování programu, tudíž není potřeba externí programátor během vývoje FW.
LoRa transceiver RFM95w je PCB (Printed Circuit Board) s čipem SX1276. Pro tento prototyp je použit integrovaný v Dragino LoRa Shield \cite{draginoWiki}, který má kompatibilní pinout s Arduino UNO, tedy i s použitým vývojovým kitem NUCLEO-L073RZ.
RS485 transceiver konvertuje rozhraní RS485/UART pro umožnění komunikace s kontrolním panelem přes síť RS485.

\begin{table}[!h]
    \centering
    \footnotesize
    \caption{Vlastnosti mikrokontroléru STM32L073RZ \cite{nucleoST}}
    \begin{ctucolortab}
    \begin{tabular}{|l|p{3.5cm}|}
    \hline

    Parametr          & Informace            \\ \hline \hline

    Microcontroller architecture & ARM Cortex-M0+ 32-bit RISC \\ \hline
    Internal flash memory & 192 KB \\ \hline
    Internal SRAM memory & 20 kB \\ \hline
    Internal EEPROM memory & 6 kB \\ \hline
    CPU frequency & up to 32 MHz \\ \hline
    Interfaces & 2X SPI, 3x I2C, 4x UART, LIN \\ \hline
    \end{tabular}
    \end{ctucolortab}
    \label{tab:mcuFeatures}
\end{table}

% Pořizovací cena kitu přímo na stránce výrobce www.st.com je \$13 \cite{nucleoST} \cite{nucleoMbed}.
% \begin{figure}[!h]
%     \centering
%     \includegraphics[width=0.4\textwidth]{Nucleo64}
%     \caption{Vývojový kit NUCLEO-L073RZ \cite{nucleoST}}
%     \label{fig:02}
% \end{figure}

% \begin{figure}[!h]
%     \centering
%     \includegraphics[width=0.2\textwidth]{RFM95w}
%     \caption{LoRa transceiver RFM95w \cite{RFM95w}}
%     \label{fig:02}
% \end{figure}

% \subsection{RS485 transceiver}
% SparkFun Transceiver Breakout - RS485 převádí rozhraní UART na RS485, pří vstupním napětí 3.3 V. A je dostupný za cenu okolo \$10 \cite{rs485tr}.

% \begin{figure}[!h]
%     \centering
%     \includegraphics[width=0.4\textwidth]{rs485transceiver}
%     \caption{RS485 transceiver \cite{rs485tr}}
%     \label{fig:rs485transceiver}
% \end{figure} 23


\subsection{Zapojení}
CKP zařízení daného přístupového systému jsou obvykle napájena napětím 12 V z kontrolního panelu. Použitý kit NUCLEO-L073RZ obsahuje stabilizátor tudíž je možné připojit gateway přímo ke kontrolnímu panelu přes vyvedené svorky GND, +12V, A a B.

LoRa shield \cite{draginoWiki} je nasazen přímo na vývojový kit Nukleo. Kit neobsahuje ISCP konektor, který je součástí pinoutu Arduino UNO a LoRa shield má SPI piny MISO a MOSI přivedeny právě na tento konektor. Musí být tedy propojeny externě viz obrázek \ref{fig:03}. 
% Jumpery na Dragino LoRa shieldu musí také být stejně jako v obrázku.

\begin{figure}[!h]
    \centering
    \includegraphics[width=1\textwidth]{foto01}
    \caption{foto zapojení}
    \label{fig:03}
\end{figure}

% TODO: popsat jak funguje na nucleu uart <-> USB prevodnik.
Pro komunikaci s LoRa transceiverem je použito SPI1, pro komunikaci přes USB je použito USART2 a pro připojení RS485 transceiveru je použito LPUART1. 
Připojení periférií k GPIO (General Purpose Input Output) mikrokontroléru je znázorněno v tabulce \ref{table:Pinout připojení periférií k mikrokontroléru}.

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
            \begin{tabular}{ |c|c|c| }
     \hline

     Periférie          & Název pinu & GPIO mikrokontroléru           \\ \hline \hline

                        & CS    &  PB6             \\
                        & CLK   &  PA5        \\
    LoRa transceiver    & MISO  &  PA6     \\
                        & MOSI  &  PA7        \\
                        & RST   & PC7          \\
                        & DIO0  & PA10         \\
                        \hline
     
                        & RX  &   PC1            \\
    RS485 transceiver   & TX  &   PC0       \\
                        & RTS  &  PB1      \\     \hline

    USB konektor        & RX    & PA3    \\
                        & TX    & PA2   \\          \hline

    \end{tabular}
    \end{ctucolortab}
    \caption{Pinout připojení periférií k mikrokontroléru}
    \label{table:Pinout připojení periférií k mikrokontroléru}
\end{table}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Použité vývojové nástroje k vytvoření FW}
Výrobce použitého mikrokontroléru STMicroelectronics poskytuje grafický nástroj STM32CubeMX \cite{stm32cubemx} ke konfiguraci mikrokontrolérů STM32 a generování odpovídajícího kódu v programovacím jazyce C.
Pomocí tohoto nástroje byl vygenerován kód pro předběžnou konfiguraci systémového hodinového signálu, IWDG, GPIO a rozhraní.

Kód byl vyvíjen v textovém editoru Visual Studio Code \cite{vscode}, kompilován kompilátorem arm-none-eabi-gcc \cite{arm-none-eabi-gcc} pomocí nástroje GNU make \cite{makefile}, výsledný binární soubor byl nahráván do procesoru pomocí nástroje st-flash \cite{st-flash} a debugován pomocí Visual Studio Code rozšíření Cortex-Debug \cite{cortex-debug}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Návrh FW gatewaye}
Pro tento vybraný případ návrhu FW není využit RTOS (Real Time Operating System), jelikož zde není potřeba řešení více úloh souběžně. 
K vývoji jsou použity drivery distribuovány výrobcem mikrokontroléru, CMSIS (Cortex Microcontroller Software Interface Standard) a HAL (Hardware Abstraction Layer).

% \subsection{Rozdělení programu}
Vyvinutý program je rozdělen na několik nezávislých podprogramů viz tabulka \ref{table:sw_div}. 

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
            \begin{tabular}{ |l|p{8cm}| }
     \hline

     Název podprogramu  & Popis           \\ \hline \hline

    LoRa            &  Knihovna zahrnující komunikaci s transceiverem RFM95W po rozhraní SPI, nainicializovaném v režimu komunikace LoRa    \\ \hline
    LoRaWAN\_packet  & Knihovna zahrnující LoRaWAN protokol, tedy dekódování a dešifrování přijatého LoraWAN paketu i vytvoření paketu pro odeslání. Tato knihovna je závislá na knihovnách aes a cmac.  \\ \hline
    LoRa\_sensors    & Knihovna zahrnující dekó dování payloadu podporovaných koncových zařízení a zapsání výsledných hodnot do bufferu, který je pak odeslán na kontrolní panel přes síť RS485       \\ \hline
    rs485\_protocol  & Podprogram zahrnující síťový protokol v síti RS485         \\ \hline
    usb             &  Podprogram zahrnující konfiguraci systému přes USB        \\ \hline
    eeprom          &  Knihovna zahrnující práci s non-volatile paměti procesoru EEPROM     \\ \hline

    \end{tabular}
    \end{ctucolortab}
    \caption{Rozdělení programu na nezávislé podprogramy}
    \label{table:sw_div}
\end{table}

Každý z těchto podprogramů je implementován ve zdrojovém souboru (source file) s koncovkou .c a hlavičkovém souboru (header file) s koncovkou .h.
Pro vytvoření knihovny zahrnující LoRaWAN protokol jsou použity open source knihovny pro šifrování, tiny-AES128-C \cite{lib_tiny-AES128-C} pro zašifrování payloadu a openpana \cite{lib_openpana} pro vytvoření CMAC (Cipher-based Message Authentication Code)


\begin{table}[!h]
    \centering
    \begin{ctucolortab}
            \begin{tabular}{ |l|p{8cm}| }
     \hline

     Název podprogramu  & Popis           \\ \hline \hline

    buffer\_ring            & Knihovna implementující cyklický buffer o velikosti 256 B   \\ \hline
    ByteArray               & Knihovna zahrnující pomocné funkce pro práci s polem bytů       \\ \hline
    LinkedList\_ByteArray   & Knihovna implementující linked list s neomezenou velikostí o datové struktuře pole bytů s ukládáním do části paměti heap    \\ \hline
    aes                     & Knihovna implementující šifrování AES-128 \cite{lib_tiny-AES128-C}                \\ \hline
    cmac                    & Knihovna pro výpočet CMAC, převzatý pouze potřebný kód z knihovný \cite{lib_openpana}       \\ \hline

    \end{tabular}
    \end{ctucolortab}
    \caption{Dodatečné pomocné podprogramy}
    \label{table:sw_div}
\end{table}

% \subsection{Ukládání informací do non-volatile paměti}
Do non-volatile paměti je ukládána konfigurace a adresa a typ všech koncových zařízení senzorové sítě.
Jako non-volatile paměť je zde využita EEPROM (Electrically Erasable Programmable Read-Only Memory) o velikosti 6144 B. 
Paměť je tedy rozdělená tak, že od adresy 0 až po adresu 6080 je prostor pro ukládání LoRaWAN zařízení a od 6080 až po adresu 6144 je prostor pro ukládání konfigurace gatewaye.
Každé LoRaWan zařízení v síti má v paměti uložené LoRaWAN device address (4 byty), typ zařízení (1 byte) a další 3 byty jsou rezervovány. 
Jedno koncové zařízení v paměti tedy zabírá  8 B, takže gateway má kapacitu paměti pro 760 koncových zařízení.
Ukládaná konfigurace obsahuje parametry v tabulce \ref{table:Parametry ukládány do non-volatile paměti gatewaye} má celkovou velikost 37 B, na konfiguraci je vyhrazeno 64 B, tudíž je zde rezerva 27 B.

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
            \begin{tabular}{ |c|p{7cm}| }
    \hline

    Velikost [B]          & Parametr           \\ \hline \hline
    1    & Adresa gatewaye v síti RS485       \\    \hline
    1    & Adresa kontrolního panelu v síti RS485       \\  \hline
    1    & Doba čekání na potvrzení od kontrolního panelu v síti RS485       \\ \hline
    1    & LoRa kanál       \\  \hline
    1    & LoRa SF       \\ \hline
    16    & LoRaWAN NwkSKey       \\ \hline
    16    & LoRaWAN AppSKey       \\ \hline
 
    \end{tabular}
    \end{ctucolortab}
    \caption{Parametry ukládány do non-volatile paměti gatewaye}
    \label{table:Parametry ukládány do non-volatile paměti gatewaye}
\end{table}

% \subsection{Běh programu}
Po spuštění programu je nejprve inicializován mikrokontrolér, hodinový signál, GPIO, rozhraní, timery a IWDG (Independent Watchdog). Systémový hodinový signál je nakonfigurová na maximální hodnotu, což je 32 MHz. Po inicializaci mikrokontroléru je z non-volatile paměti EEPROM vyčtena a vypsána v logu aktuální konfigururace gatewaye a následuje inicializace LoRa transceiveru RFM95w dle načtené konfigurace a nakonec je vstoupeno do hlavní smyčky běhu programu, kde jsou dokola nepřetržitě zpracovávány cyklické buffery a fronty tvořeny linked listy. 

Jsou zde použity 2 timery, TIM2 pro restartování procesoru a TIM3 pro resetování IWDG.
Resetování procesoru po daném intervalu defaultně není použito, ale je implementováno a v případě potřeby je možné využít.IWDG je resetováván timerem tudiž tvoří pojistku že resetuje procesor v případě že by se program zhroutil.

Komunikace s transceiverem RS485 přes LPUART1 je je implementována pro vysílání v blokujícím módu a přijímání přes interrupt, kde přijatý byte je zapsán do cyklického bufferu o velikosti, který je zpracováván v hlavní smyčce běhu programu. 
Jelikož komunikace v síti RS485 je half-duplex a platí zde pravidlo LBT, vysílání je zde blokováno po dobu 20 ms od posledního přijatého bytu.

Komunikace s LoRa transceiverem RFM95W přes rozhraní SPI1 je implementována v blokujícím módu zápisem a čtením registrů. 
LoRa transceiver je nakonfigurován na kontinuální příjem na zvoleném kanále a SF, přijatý LoRa paket signalizuje zvednutím logické úrovně pinu DIO0. Toto je řešeno interrupt pinem, po jehož přerušení je vyčten přijatý LoRa paket z FIFO (First In First Out) paměti transceiveru a přidán do fronty tvořené linked listem, zpracovávané v hlavní smyčce běhu programu, kde pakety z této fronty jsou postupně dekódovány a diešifrovány, na základě typu zařízení jsou vypočteny hodnoty senzorů z payloadu a zakódovány do bufferu o délce 6 B, který je připojen do fronty tvořené linked listem, zpracovávané v hlavní smyčce běhu programu.

Komunikace přes USB přes USART2 je implementována obdobně jako komunikace v síti RS485 kde přijatá data jsou zapsána do cyklického bufferu, který je zpracováván v hlavní smyčce běhu programu, ale vysílání neni blokováno během přijímání, jelikož se jedná o full-duplex.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Komunikace přes sériovou linku USB}
\label{Komunikace přes sériovou linku}
Gateway má implementovanou komunikaci přes sériovou linku, umožňující konfiguraci a log. 
K přípojení lze použít PC s libovolnou aplikací umožňující odesílání a přijímání dat zakódovaných ASCII (American Standard Code for Information Interchange) po
sériové lince s nastavením parametrů dle tabulky \ref{table:usb_term}.

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
    \begin{tabular}{ |c|c| }
     \hline

    Parametr                & Hodnota           \\ \hline \hline
     Baud rate              & 115200           \\ \hline
     Data bits              & 8                 \\ \hline
     Parity                 & none              \\ \hline
     Stop bits              & 1                 \\ \hline
     Flow control           & none               \\ \hline

    \end{tabular}
    \end{ctucolortab}
    \caption{Parametry sériové linky PC terminálu pro komunikaci s gatewayí}
    \label{table:usb_term}
\end{table}

Při komunikaci jsou data oddělována bytem CR (carriage return) 0x0D, ale je akceptována i sekvence CR LF (Line Feed), tedy 0x0D 0x0A v hexadecimálním tvaru. 




\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Log Gatewaye}
Po připojení ke gatewayi přes sériovou linku dle instrukcí v sekci \nameref{Komunikace přes sériovou linku} je možné kontinuálně snímat a log gatewaye obsahující informace o proběhlých událostech. Je-li gateway v normálním pracovním režimu, loguje informace automaticky přes sériovou linku a komunikace je zde pouze jednosměrná, tedy gateway vysílá a PC přijímá.
Níže je příklad výpisu logu v případě, kdy gateway přjala LoRaWAN paket z koncového zařízení senzorové sítě, zpracovala ho a výslednou informaci odeslala na kontrolní panel přes RS485 síť.

\begin{lstlisting}[style=log]
    ________________________________________________
    Rx -> LoRaWAN, pktCntr: 6
    RSSI: -51, SNR: 9, length: 22

    Message type: Unconfirmed Data Up
    Packet rawData: "40F61F0128C0D62508D970CB071595D115BAC68F6663"
    Device Address: "F61F0128"
    FCnt: 9686
    message (encrypted): "D970CB071595D115BA"
    MHDR: 40; FCtrl: C0; FPort: 08; MIC: "C68F6663"
    adaptive data rate: true; ack: false
    message HEX (decrypted): "013566779600FFFFAF"

    Sensor type: RHF1S001
    temperature: 23.30 C, humidity: 52 %
    period: 300 s, RSSI: -51 dBm, SNR: 9 dB, battery voltage: 3.2 V
    Tx -> RS-485: "FF1F100D00D0F61F01281A0934CDFFFF09202E"
    ________________________________________________
    Rx -> RS-485: "AA1FFF060000E6"
    ACK
\end{lstlisting}

Nejprve jsou vypsány data týkající se LoRaWAN protokolu, zašifrovaný i dešifrovaný datový obsah (payload) koncového zařízení, typ zařízení a výsledné hodnoty dekódované z payloadu.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Konfigurace gatewaye}
\label{Konfigurace gatewaye}
Konfigurace gatewaye se provádí obousměrnou komunikací po sériové lince s připojením dle instrukcí v sekci \nameref{Komunikace přes sériovou linku}.
Po spuštění je gateway v normálním pracovním režimu, přeposílá tedy pakety ze senzorové sítě přes RS485 síť na kontrolní panel a informace loguje přes sériovou linku.
Po vstoupení do stavu konfigurace je pozastavena činnost gatewaye, komunikace s koncovými zařízeními LoRaWAN sítě a komunikace s kontrolním panelem v síti RS485 nejsou aktivní.
Do režimu konfigurace je vstoupeno odesláním "config", následuje vypsání současného stavu konfigurace a následně uživatel postupuje zadáním čísla pro výběr možnosti z menu či konkrétního parametru dle vyzvání. Z konfigurace je možné vystoupit kdykoliv bez uložení změn příkazem "quit". 
Procházení jednotlivými menu je navrženo jednoduše tak, aby uživatel nepotřeboval dokumentaci a aby zde vždy bylo uvedeno dost informací pro srozumitelnost.
Níže je zobrazen příklad výpisu po vstupu do konfigurace obsahující informaci o aktuální konfiguraci a hlavní konfigurační menu.

\begin{lstlisting}[style=log]

    _________________Entering configuration setup________________
    
    System configuration:
    
    *** LoRa channel: 
    channel: 0 (868.1 Mhz)
    SF7
    
    *** RS485 channel: 
    my address: 10
    master address: FF
    timeout: 3 s
    
    *** LoRaWAN keys: 
    NwSKey:  FD 90 0D 8C 70 9F 19 24 18 EC FD D4 28 0C AC 47
    AppSKey:  68 9F D0 AC 7A 0F 95 58 B1 19 A0 16 17 F4 16 33
    
    
    Config menu:
    1 -> Config LoRa channel
    2 -> Config RS485 channel
    3 -> Config LoRaWAN protocol
    4 -> Print all LoRaWAN devices
    5 -> Erase all LoRaWAN devices
    6 -> Restore to default configuration
    7 -> Exit without save
    8 -> Save and exit

\end{lstlisting}
    

Jsou zde tedy tři sekce konfigurace, LoRa kanál, RS485 kanál a parametry LoRaWAN protoklu.
Dále jsou zde další možnosti hlavně pro diagnostické účely, a to možnost ručně přidat LoRaWAN koncové zařízení a vymazání všech koncových zařízení, ačkoliv je to obvykle prováděno ze serveru řízení přístupu, a navrácení stavu gatewaye do defaultního stavu. Dále jsou zde možnosti vystoupení z menu s či bez uložení změn, tedy zapsání nově nakonfigurovaných parametrů do non-volatile paměti.

Při procházení jednou ze tří možných konfigurací je vždy pro každý parametr vypsáno jaká data mají být uživatelem zadána v jakém tvaru a zároveň současnou hodnotu měněného parametru. Zadaná data uživatelem jsou vždy zkontrolována zda splňují požadovaný tvar. Pokud ne, uživatel je o tom informován a vyzván k dalšímu pokusu.
Pokud uživatel některý parametr nehodlá měnit, přeskočí ho odesláním ASCII znaku LF (0x0D) u většiny terminálových aplikací stačí pouze stisknout na klávesnici Enter.
Po provedení některé konfigurace následuje vždy návrat zpět do hlavního menu. Pro uložení nové konfigurace je potřeba v menu vybrat "Save and exit", gateway pak následně vypíše které parametry byly změněny a provede restart. Pokud je vybráno "Exit without save", gateway se pouze restartuje.


\subsubsection{Konfigurace LoRa kanálu}
Položka v menu pod názvem "Config LoRa channel" zahrnuje nastavení SF, tedy přenosovou rychlost a frekvenční kanál. Níže je příklad konfigurace.

\begin{lstlisting}[style=log]
    LoRa channel configuration:
    Enter SF number (7-12)
    (current: 7)
    8
    SF8 set.

    Enter LoRa channel number (0-7)
    ch0 is 868.1 Mhz
    ch1 is 868.3 Mhz
    ch2 is 868.5 Mhz
    ch3 is 867.1 Mhz
    ch4 is 867.3 Mhz
    ch5 is 867.5 Mhz
    ch6 is 867.7 Mhz
    ch7 is 869.0 Mhz
    (current: 0)
    1
    channel 1 set.
\end{lstlisting}

\subsubsection{Konfigurace RS485 kanálu}
Položka v menu pod názvem "Config RS485 channel" zahrnuje nastavení adresy gatewaye, tedy tohoto zařízení, adresy kontrolního panelu a timeout, což je doba čekání na potvrzení od kontrolního panelu po odeslání příkazu "průchod". Níže je příklad konfigurace.

\begin{lstlisting}[style=log]
    RS485 channel configuration:
    Enter address of this device, FF and 00 are reserved.
    (current: 10)
    11
    Address of this device is set to: 11

    Enter master address: 
    (current: FF)
    FE
    Master address is set to: FE

    Enter timeout (seconds)
    (current: 3)
    5
    timeout set to: 5 s
\end{lstlisting}


\subsubsection{Konfigurace LoRaWAN protokolu}
Položka v menu pod názvem "Config LoRaWAN protocol" zahrnuje nastavení šifrovacích klíčů NwkSKey a AppSKey. Níže je příklad konfigurace.

\begin{lstlisting}[style=log]    
    LoRaWAN protocol configuration:
    Enter NwkSKey (16 bytes in HEX)
    (current:  FD 90 0D 8C 70 9F 19 24 18 EC FD D4 28 0C AC 47)
    11111111222222223333333344444444
    NwSKey set to: 11 11 11 11 22 22 22 22 33 33 33 33 44 44 44 44

    Enter AppSKey (16 bytes in HEX)
    (current:  68 9F D0 AC 7A 0F 95 58 B1 19 A0 16 17 F4 16 33)
    11111111222222223333333344444444
    AppSKey set to: 11 11 11 11 22 22 22 22 33 33 33 33 44 44 44 44
\end{lstlisting}


\subsubsection{Print all LoRaWAN devices}
Vypíše všechna LoRaWAN zařízení uložená v paměti. Níže je příklad.


\begin{lstlisting}[style=log]    
    number.......................0:
    Device Address:  B1 C4 12 00
    Device Type: RH1S001
    number.......................1:
    Device Address:  B2 C4 12 00
    Device Type: RH1S001
    number.......................2:
    Device Address:  B3 C4 12 00
    Device Type: RH1S001
    number.......................3:
    Device Address:  B4 C4 12 00
    Device Type: IMA_tempPress
    number.......................4:
    Device Address:  B5 C4 12 00
    Device Type: IMA_tempPress
\end{lstlisting}



\subsubsection{Restore default configuration}
Po zvolení této možnosti je načtena defaultní konfigurace systému, která obsahuje hodnoty viz tabulka \ref{table:5}. Tyto defaultní hodnoty jsou nastaveny v programu a slouží především pro testovací účely.

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
    \begin{tabular}{ |l|l| }
     \hline

     popis              & hodnota         \\ \hline \hline
     RS485 myAddr       & 0x10            \\ \hline
     RS485 MasterAddr   & 0xFF            \\ \hline
     RS485 timeout      & 3               \\ \hline
     LoRa SF            & SF7             \\ \hline
     LoRa channel       & 0 (868.1 Mhz)   \\ \hline
     NwSKey             & FD 90 0D 8C 70 9F 19 24 18 EC FD D4 28 0C AC 47  \\ \hline
     AppSKey            & 68 9F D0 AC 7A 0F 95 58 B1 19 A0 16 17 F4 16 33  \\ \hline

    \end{tabular}
\end{ctucolortab}
    \caption{Defaultní konfigurace systému}
    \label{table:5}
\end{table}



\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Podpora koncových zařízení}
Jak již bylo zmíněno v sekci \label{Implementace WSN do přístupového systému}, z důvodu datového omezení protokolu sítě RS485 jsou LoRaWAN pakety koncových zařízení dekódovány v gatewayi a z datového obsahu (payloadu) vypočítány konečné hodnoty dle dokumentace daného LoRaWAN zařízení a přes síť RS485 na kontrolní panel jsou odeslány pouze vybraná data. Gateway má pro každé koncové zařízení uloženou 4 byty dlouhou adresu a 1 byte typ zařízení.
Momentálně jsou podporovány dva typy koncových zařízení, dle potřeby je možné rozšířit FW gatewaye o další typy koncových zařízení. Tabulka \ref{table:TypyKoncZarizeni} ukazuje hodnotu bytu označující typ koncového zařízení odpovídající konkrétním typům koncových zařízení.

\begin{table}[!h]
    \centering
    \begin{ctucolortab}
    \begin{tabular}{ |l|l| }
     \hline

     Typ zařízení       & Hodnota         \\ \hline \hline
     RHF1S001           & 0x00            \\ \hline
     IMA\_tempPress     & 0x01            \\ \hline
     
    \end{tabular}
    \end{ctucolortab}
    \caption{Typy koncových zařízení}
    \label{table:TypyKoncZarizeni}
\end{table}

% \subsection{Zpracování dat jednotlivých typů koncových zařízení}
Níže je popsáno pro jednotlivá podporovaná koncová zařízení jak jsou data uložena v datové struktuře, jak jsou data z této struktury zpracována a zobrazena a nakonec jak vybraná data jsou zapsána do výsledného bufferu o délce 6 B, který je odeslán přes síť RS485 příkazem "průchod".


\subsubsection{RHF1S001}
Senzor od firmy RisingHF měřící teplotu a vlhkost \cite{RHF1S001 pdf}.

\begin{lstlisting}[style=CStyle]
    /* RHF1S001 data structure */   
    typedef struct {
        int16_t temperature;
        uint8_t humidity;
        uint16_t period;
        int8_t rssi;
        int8_t snr;
        uint8_t battery;
    } RHF1S001_data_t;

    /* Print the data from the structure */
    printf("temperature: %d.%d C, ", RHF1S001_data.temperature / 100, RHF1S001_data.temperature % 100);
    printf("humidity: %d %%\n", RHF1S001_data.humidity);
    printf("period: %d s, ", (int)RHF1S001_data.period);
    printf("RSSI: %d dBm, ", RHF1S001_data.rssi);
    printf("SNR: %d dB, ", RHF1S001_data.snr);
    printf("battery voltage: %d.%d V\r\n", RHF1S001_data.battery/10, RHF1S001_data.battery % 10);

    /* Put the data into 6 B long buffer, to be transmitted to the control panel */
    buffer[0] = RHF1S001_data.temperature & 0xFF;
    buffer[1] = RHF1S001_data.temperature >> 8;
    buffer[2] = RHF1S001_data.humidity;
    buffer[3] = RHF1S001_data.rssi;
    buffer[4] = RHF1S001_data.snr;
    buffer[5] = RHF1S001_data.battery;
\end{lstlisting}


\subsubsection{IMA\_tempPress}
Senzor vytvořený ve firmě IMA, měřící teplotu a tlak.

\begin{lstlisting}[style=CStyle]
    /* IMA_tempPress data structure */   
    typedef struct {
        int16_t temperature;
        uint16_t pressure;
        int8_t rssi;
        int8_t snr;
    } IMA_tempPress_data_t;
     
    /* print the data from the structure */
    printf("temperature: %d.%d C, ", IMA_tempPress_data.temperature / 100, IMA_tempPress_data.temperature % 100);
    printf("pressure: %d.%d Pa\r\n", IMA_tempPress_data.pressure/10, IMA_tempPress_data.pressure % 10);
    printf("RSSI: %d dBm, SNR: %d dB\r\n", IMA_tempPress_data.rssi, IMA_tempPress_data.snr);

    /* Put the data into 6B long buffer, that is transmitted to the K4 server */
    buffer[0] = IMA_tempPress_data.temperature & 0xFF;
    buffer[1] = IMA_tempPress_data.temperature >> 8;
    buffer[2] = IMA_tempPress_data.pressure & 0xFF;
    buffer[3] = IMA_tempPress_data.pressure >> 8;
    buffer[4] = IMA_tempPress_data.rssi;
    buffer[5] = IMA_tempPress_data.snr;
\end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Přidávání koncových zařízení ze serveru řízení přístupu}
Přidávání koncových zařízení senzorové sítě se provádí z uživatelského rozhraní serveru řízení přístupu stejně jako přidávání platných RFID karet, s délkou UID 8 B.
Adresa koncového zařízení (LoRaWAN device address) je dlouhá 4 B, jeden byte je navíc použit pro typ koncového zařízení, zbylé 3 byty jsou nuly.
Jelikož typ zařízení je uložen v gatewayi i na serveru řízení přístupu. Při odesílání příkazu "průchod" se tedy už typ zařízení neposílá z důvodu omezené velikosti tohoto příkazu.
Na serveru řízení přístupu se UID nastavuje jako dekadické číslo.

\subsubsection{Příklad}
Pro případ, kde typ zařízení je 01 a DevAddr AABBCCDD (little endian) výsledné číslo v hexadecimální podobě je 01DDCCBBAA. Následně se překládá do decimalni podoby, výsledné číslo k zadání do uživatelského rozhraní serveru řízení přístupu je tedy 8016149418.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Návrh WSN gatewaye verze 2}
Pro lepší mechanické uspořádání byla navržena verze 2, kde je použit i jiný vývojový kit NUCLEO-L432KC s procesorem STM32L432KC, který je výkonnější.
Navíc je zde přidán externí stabilizátor, napěťový filtr, přepínačem volitelné impedanční zakončení sítě RS485 a proudové ochrany.

\begin{figure}[!h]
    \centering
    \includegraphics[width=1\textwidth]{minigateway_schema}
    \caption{Návrh WSN gatewaye verze 2 - schéma}
    \label{fig:minigateway_schema}
\end{figure}

\begin{figure}[!h]
    \centering
    \includegraphics[width=0.7\textwidth]{minigateway_plosnak}
    \caption{Návrh WSN gatewaye verze 2 - plošný spoj}
    \label{fig:minigateway_plosnak}
\end{figure}




























%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%   NOT USED
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% \subsection{Zdrojové soubory projektu}
% Níže je seznam zdrojových souborů.
% \begin{figure}[!h]
%     \dirtree{%
%         .1 Drivers \DTcomment{STM32 Drivers}.
%         .1 Inc\DTcomment{Headers}.
%             .2 aes.h\DTcomment{AES-128 library for LoRaWAN paket encryption}.
%             .2 cmac.h\DTcomment{library for CMAC calculation in LoRaWAN protocol}.
%             .2 LinkedList\_ByteArray.h \DTcomment{Byte array linked list library for stacks}.
%             .2 LoRaWAN\_paket.h\DTcomment{LoRaWAN library for paket data decoding}.
%             .2 stm32l0xx\_hal\_conf.h\DTcomment{HAL initialization of peripherals}.
%             .2 ByteArray.h\DTcomment{Library for Byte array operations}.
%             .2 LoRa.h\DTcomment{Library for interfacing LoRa transceiver}.
%             .2 main.h\DTcomment{Main file}.
%             .2 stm32l0xx\_it.h\DTcomment{HAL initialization of peripherals}.
%             .2 eeprom.h\DTcomment{Library for eeprom operations}.
%             .2 LoRa\_sensors.h\DTcomment{Library for decoding data from payload}.
%             .2 rs485\_protocol.h\DTcomment{Library for RS485 IMA protocol}.
%             .2 usb.h \DTcomment{Library for USB communication and system configuration}.
%         .1 Src\DTcomment{Sources}.
%             .2 aes.c \DTcomment{source file to the aes.h}.
%             .2 aes.c \DTcomment{source file to the cmac.h}.
%             .2 LinkedList\_ByteArray.c \DTcomment{source file to the LinkedList\_ByteArray.h}.
%             .2 LoRaWAN\_paket.c  \DTcomment{source file to the LoRaWAN\_paket.h}.
%             .2 stm32l0xx\_hal\_msp.c \DTcomment{HAL source file}.
%             .2 ByteArray.c  \DTcomment{source file to the ByteArray.h}.
%             .2 LoRa.c \DTcomment{source file to the LoRa.h}.
%             .2 main.c \DTcomment{main source file}.
%             .2 stm32l0xx\_it.c \DTcomment{HAL source file}.
%             .2 eeprom.c \DTcomment{source file to the eeprom.h}.
%             .2 LoRa\_sensors.c \DTcomment{source file to the LoRa\_sensors.h}.
%             .2 rs485\_protocol.c  \DTcomment{source file to the rs485\_protocol.h}.
%             .2 system\_stm32l0xx.c \DTcomment{HAL source file}.
%             .2 usb.h \DTcomment{source file to the usb.h}.
%     }
% \end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{Nahrání programu do MCU}
% Výstupem kompilace je soubor s koncovkou .binary, který je nahrán do MCU. K tomuto nahrání není potřeba žádný speciální SW nebo HW.
% Stačí kit připojit k PC přes USB, v PC se kit zobrazí jako flash disk. Zkompilovaný program s koncovkou .binary stačí překopírovat na toto zařízení. 
% Po dobu kopírování souboru bliká na kitu LED1 červená/zelená. Jakmile kopírování skončí, program na kitu je spuštěn, případně je možné kit resetovat černým tlačítkem reset.
% Pro uvedení Gatewaye do provozu je nutné se připojit k zařízení přes USB a nastavit všechny parametry viz sekce \ref{sec:konfigurace}.  







%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{Implementace komunkičního protokolu v síti IMA\_RS485 pro komunikaci s control panelem}
% V tomto projektu je komunikace protokolu IMA\_RS485 naprogramována v souborech rs485\_protocol.h a rs485\_protocol.c. 
% Jedná se o kolizní protokol v síti, kde je připojen jedno zařízení typu master, a jeden nebo více zařízení v typu slave.

% \begin{table}[!h]
%     \centering
%     \begin{tabular}{ |c|c| }
%      \hline

%      Baud rate              & 9600           \\ \hline
%      Data bits              & 8                 \\ \hline
%      Parity                 & none              \\ \hline
%      Stop bits              & 1                 \\ \hline

%     \end{tabular}
%     \caption{Fyzické vlastnosti IMA\_RS485 sítě}
%     \label{table:3}
% \end{table}

% \newpage
% \subsection{Syntaxe příkazů}
% Komunikace v síti probíhá formou příkazů, které mají specifikovanou syntaxi v tabulce \ref{table:syntaxePrikazu}.

% \begin{table}[!h]
%     \centering
% \begin{tabular}{ |c|| p{1.5cm} | p{1.5cm} | p{1cm} | p{1cm} | p{1cm} | p{1cm} | }
%  \hline
%  popis      & adresa příjemce & adresa odesílatele & typ příkazu & délka dat & data & crc\\ \hline
%  počet bytů & 1               & 1   & 1     & 2     & délka dat     & 1 \\ 
%  \hline
% \end{tabular}
%     \caption{Syntaxe příkazu pro komunikaci v síti IMA\_RS485}
%     \label{table:syntaxePrikazu}
% \end{table}

% Typy příkazu jsou zadefinované konstanty s předponou CKP\_CMD\_ v souboru ./Inc/rs485\_protocol.h.
% Příkazy odeslané zařízením typu master obsahují navíc synchronizační byte na začátku 0xAA.
% CRC je pro kontrolu XOR přes všechny předchozí byty v celém příkazu kromě synchronizačního bytu.

% \subsection{Adresace zařízení v síti}
% Každé zařízení na této sběrnici má svoji adresu, která mu je nastavena externě. Zařízení typu master má adresu  0xFF, adresa pro všechny (broadcast) je 0x00 a zařízení v této sítí můžou mít adresu libovolnou (krom těchto dvou) nesmí zde však být připojena 2 zařízení s nastavenou stejnou adresou.

% \subsection{Statusy}
% Zařízení typu slave má dva možné statusy v síti IMA\_RS485, offline a online. Zařízení typu slave má povoleno odesílat příkaz "průchod" pouze má-li status online.  
% Zařízení typu slave odesílá příkaz obsahující informaci o jeho statusu periodicky s typem příkazu 0x10 a jedním bytem dat označujícím status. 
% Pro status online je tento byte 0x00 a pro status offline 0xEE. 
% Tento příkaz je odesílán s intervalem 10 s, pokud zařízení má status offline a s intervalem 30 s, pokud má zařízení status online.
% Status zařízení mění pouze zařízení typu master odesláním příkazu s typem 0x41 pro přepnutí na status online a 0x42 pro přepnutí na status offline.
% Zařízení typu slave svůj status přepne samo pouze v případě, že má status online a zařízení typu master přestane odpovídat na příkaz průchod, jak je popsáno v sekci \ref{sec:Odesílání dat z koncových zařízení}.
% Je-li zařízení spuštěno, je ve stavu offline a jelikož nemá povoleno odesílat příkaz "průchod", přijatá data z koncových zařízení jsou zahazována. 
% Zařízení typu slave pouze odpovídá na příkazy od zařízení typu master a čeká na příkaz od zařízení typu master k přepnutí na status online.


% \subsection{Přidávání LoRaWAN zařízení do systému}
% Pokud zařízení typu master přijme příkaz od zařízení typu slave oznamující že je ve stavu offline, nejprve tomuto zařízení pošle seznam LoRaWAN adres všech známých koncových zařízení a následně toto zařízení přepne do stavu online.
% Přijímání seznamu adres je realizováno sekvencí příkazů typu 0x8F. 

% Níže v tabulce \ref{table:2} je příklad sekvence příkazů odesílaných mezi zařízením typu masterem a zařízením typu slavem během předávání seznamu LoRaWAN device address koncových zařízení, kde zařízení typu slave má adresu 0x10 a zařízení typu master standardně 0xFF. Jak již bylo řečeno, příkazy od zařízení typu master lze jednoduše odlišit tím, že vždy začínají bytem 0xAA.


% \begin{table}[!h]
%     \begin{tabular}{ |l|p{10cm}| }
%     \hline
%     příkaz      &  data    \\ \hline \hline
%     master: start      &  AA 10 FF 8F 02 00 00 00 62    \\ \hline
%     slave: ACK        &  FF 10 06 02 00 8F 00 64    \\ \hline
%     master: data     &  AA 10 FF 8F 21 00 01 B1 C4 12 00 00 00 00 00 B2 C4 12 00 00 00 00 00 B3 C4 12 00 00 00 00 00 B4 C4 12 00 00 00 00 00 44 \\ \hline
%     slave: ACK      &  FF 10 06 02 00 8F 01 65   \\ \hline
%     master: data     &  AA 10 FF 8F 19 00 02 B5 C4 12 00 00 00 00 00 B6 C4 12 00 00 00 00 00 F6 1F 01 26 00 00 00 00 B6 \\ \hline
%     slave: ACK      &   FF 10 06 02 00 8F 02 66   \\ \hline
%     master: konec   &   AA 10 FF 8F 04 00 03 FF 2A 57 E5   \\ \hline
%     slave: ACK      &   FF 10 06 02 00 8F 03 67  \\ \hline
%     \end{tabular}
%     \caption{Příklad sekvence příkazů odesílaných mezi zařízením typu master a zařízením typu slave během předávání seznamu LoRaWAN device address koncových zařízení}
%     \label{table:2}
% \end{table}

% LoraWAN protokol používá 4-bytové adresy koncových zařízení.
% Adresy předávány touto sekvencí jsou dlouhé 8-bytové. První 4 byty je tedy LoRaWAN device address, pátý byte je typ zařízení a zbylé 3 byty jsou nevyužity, jejich použití je možné v případě změn či rozšiřování vlastností systému. 

% První Byte dat je counter paketu začínající od nuly, který označuje číslo odeslaného paketu v sekvenci. Na každý tento paket v sekvenci zařízení typu slave odpovídá ACK příkaz, který se liší od obyčejného ACK příkazu tím, že v datech paketu navíc obsahuje counter pakety v sekvenci.
% První příkaz této sekvence má délku dat 2 byty, které mají hodnotu 0x00 přičemž první je counter.
% Další příkazy hned za counter bytem obsahují několik osmibytových adres, jejichž počet je různý.
% Příkaz ukončující tuto sekvenci příkazů má délku 4 byty, což je tedy counter, 0xFF a 2 byty CRC přes všechny odeslané adresy (nepodstatné, tudíž ho nepoužívám).

% \subsection{Odesílání dat z koncových zařízení} 
% \label{sec:Odesílání dat z koncových zařízení}
% Jak je popsáno v sekci \ref{sec:Implementace IoT do přístupového systému firmy IMA}, tudíž data z koncových zařízení jsou odesílána příkazem "průchod", jehož typ je 0x10 a kapacita na data z koncového zařízení je pouze 6 B. 
% První byte dat označuje typ průchodu, byl zvolen konstantní byte 0xD0. Dále následuje LoRaWAN adresa koncového zařízení od kterého byl paket přijat. Dále následují 4 byty dat ze senzoru, další 2 byty signalizující čas průchodu, což v tomto projektu není použito a tyto dva byty mají vždy hodnotu 0xFF. A nakonec jsou další 2 byty obsahující data ze senzoru.
% Příklad příkazu: FF 1F 10 0D 00 D0 F6 1F 01 29 AD 0A 5A 27 FF FF DE 09 E1.
% Data příkazu jsou níže rozepsána v tabulce \ref{table:prikladprikazpruchod}.

% \begin{table}[!h]
%     \centering
% \begin{tabular}{ | p{1.5cm} | p{3cm} | p{2.5cm} | p{1.3cm} | p{1.3cm} |  }
%  \hline
%  typ průchodu & LoRaWAN device address & data (4B)     & cas   & data (2B) \\ \hline
%  D0           & F6 1F 01 29            &  AD 0A 5A 27  & FF FF & DE 09     \\ 
%  \hline
% \end{tabular}
%     \caption{Příklad dat příkazu "průchod" odeslaného z gatewaye na zarizeni typu master, obsahující data z koncových zařízení}
%     \label{table:prikladprikazpruchod}
% \end{table}

% Zařízení typu master na příkaz "průchod" odpovídá příkazem ACK. Zařízení typu slave na tuto odpověď čeká standardně 3 sekundy, ale tento parametr je nastavitelný. Pokud v tomto timeoutu zařízení typu master neodpoví, zařízení typu slave příkaz "průchod" zopakuje přičemž změní typ příkazu na 0x20. Pokud zařízení typu master ani na třetí opakování neodpoví ACK, zařízení typu slave se přepne do stavu offline a vymaže frontu příkazů "průchod" k odeslání.

% \subsection{Potvrzení}
% Zařízení typu slave odpovídá na každý příkaz od zařízení typu master ACK. Typ příkazu ACK je 0x06 a data příkazu obsahují jeden byte signalizující typ příkazu na který je právě odpovídáno potvrzením.
% Zařízení typu master odpovídá ACK se stejným typem příkazu 0x06, ale s žádnými daty příkazu.

% \subsection{Dotaz na příznaky}
% Zařízení typu master se může zeptat s jak dlouhými adresami zařízení typu slave pracuje s typem příkazu 0x49. Zařízení typu slave na to odpovídá ACK s tím, že v datech příkazu je navíc byte 0x04. Zařízení typu master pak počítá s tím, že zařízení typu slave pracuje se 64-bit adresami (ve skutečnosti ale používá 32-bitové a zbylé 4 byty v příkazu průchod jsou pro data z koncového zařízení).
