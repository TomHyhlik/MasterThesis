% \chapter{Measurement Results and Discussion}
\chapter{Měření, výsledky a diskuse}
\DIFaddbegin \DIFadd{Tato kapitola zahrnuje testování navržené senzorové sítě v univerzítní budově ČVUT za reálného provozu.
}\DIFaddend 

\DIFaddbegin \DIFadd{Testování je provedeno v jednom bloku patra univerzity, kde je do jednoho kontrolního panelu připojeno dvanáct CKP zařízení přes síť RS485. Každé z nich ovládá jedny dveře, tedy jednu čtečku a dveřní zámek.
Do této sítě RS485 je navíc připojena navržená gateway jako třinácté CKP zařízení.
K této navržené gatewayi senzorové sítě jsou připojena koncová zařízení se senzory teploty a vlhkosti.
Gateway a CKP zařízení jsou zapojena del blokového schematu v obrázku \ref{fig:ACS architecture IMA with geteway}.
Konkrétní rozmístění stávajcích dvanácti CKP zařízení, gatewaye a dvou koncových zařízení senzorové sítě v testovaných prostorách budovy je zobrazeno v obrázku \ref{fig:CorridorFloorPlan}.
}

\DIFaddend \begin{figure*}[!ht]
    \centering
    \includegraphics[width=0.9\textwidth]{5patro}
    \caption{\DIFdelbeginFL \DIFdelFL{Location of sensor nodes and }\DIFdelendFL \DIFaddbeginFL \DIFaddFL{Rozmístění koncových zařízení sítě a zařízení }\DIFaddendFL CKP \DIFdelbeginFL \DIFdelFL{devices on the university floor}\DIFdelendFL \DIFaddbeginFL \DIFaddFL{v testovaných prostorách budovy}\DIFaddendFL }
    \label{fig:CorridorFloorPlan}
\end{figure*}

%DIF <  One floor block of university building is selected to perform the test. It is equipped with twelve CKP devices, each controlling one Door Lock and one Reader. One Gateway is added to the infrastructure, i.e., thirteen devices are connected to one RS485 network. Two temperature/humidity sensor nodes are wirelessly connected to the Gateway. The Gateway and CKP devices are connected via RS485 network as shown in Fig. \ref{fig:Access control system architecture}. The specific location of CKP devices, Gateway and two sensor nodes on the floor is shown in Fig. \ref{fig:CorridorFloorPlan}.
\DIFaddbegin \DIFadd{Testování probíhalo od 21. září do 31. října, tedy v době přítomnosti studentů a zaměstnanců v testovaných prostorách. 
Po tuto dobu testování byly zaznamenávány přenášené pakety síti RS485, kontrolní panel přijal 1~876~978 paketů (14~074~522 B) a odeslal 1~101~556 paketů (8~295~219 B), dohromady tedy 2~978~534 paketů (22~369~741 B).
Z naměřených hodnot byla provedena metoda frekvencni analízy. Z přenesených paketů byly nejdelší 3 o velikostí 40 bytů.
S ohledem na celkové množství paketů je to zanedbatelné množství, tj. 1,3E-04 \%.
Avšak vzhledem k povaze systému, tedy ystému s primární funkcí řízení přístupu do omezených oblastí, se za nejhorší scénář považuje nepřekonatelný limit.
}\DIFaddend 

%DIF <  The long-term operation test is carried out from 21$^{st}$ September to 31$^{th}$ October, i.e., in the period involving the presence of students and employees in the classrooms and offices on the monitored floor of the university.
%DIF <  During this period, the Control Panel received 1~876~978 packets (14~074~522 Bytes) and sent 1~101~556 packets (8~295~219 Bytes) from/to RS485 network. 
%DIF <  The lengths of all 2~978~534 packets, i.e., 22~369~741 Bytes, are recorded in RS485 network during long-term operation test and the frequency analysis  method, i.e., the number of packet lengths in monitored period, is performed. Three packets reach the largest value, i.e., 40 Bytes. 
%DIF <  Considering the total amount of packets, it is negligible quantity, i.e, 1.3E-04\%. However, given the nature of the system, i.e., the system with the primary function of access to a restricted area, the worst-case scenario is considered to be an uncrossable limit. 
%DIF <  Number of sensor nodes that can be wirelessly connected to the Gateway and does not affect the existing access control system, can be calculated in dependence on used RS485 data rate. The reserve of the data rate is considered in order to protect the access control system from malfunction, e.g., a long waiting for the door to open.
\DIFaddbegin \DIFadd{Maximální počet koncových zařízení připojených ke gatewayi při kterém není ovlivněn stávájcí přístupový systém je možné vypočítat z objemu přenášených dat v síti RS485. 
Tato rezerva objemu přenášených dat je uvažována za účelem ochrany přístupového systému před poruchou, například před dlouhým čekáním na otevření dveří.
}\DIFaddend 

%DIF <  \begin{table}[h]
%DIF <  \centering
%DIF <  \footnotesize
%DIF <  \caption{Packet length frequency analysis}
%DIF <  \begin{tabular}{cr}
%DIF <  Packet length &  Count \\ \hline
%DIF <  \textbf{7}  &  \textbf{2~216~098}  \\
%DIF <  8  &   619~127   \\
%DIF <  9  &         3   \\
%DIF <  11 &    58~393   \\
%DIF <  13 &    58~620   \\
%DIF <  16 &         1   \\
%DIF <  18 &         2   \\
%DIF <  \textbf{19} &    \textbf{26~286}   \\
%DIF <  23 &         1   \\
%DIF <  40 &         3   \\
%DIF <  \end{tabular}
%DIF <  \label{tab:FreqAnalysis}
%DIF <  \end{table}
\DIFaddbegin \begin{table}[h]
\centering
\footnotesize
\caption{\DIFaddFL{Packet length frequency analysis}}
\begin{tabular}{cr}
\DIFaddFL{Packet length }&  \DIFaddFL{Count }\\ \hline
\textbf{\DIFaddFL{7}}  &  \textbf{\DIFaddFL{2~216~098}}  \\
\DIFaddFL{8  }&   \DIFaddFL{619~127   }\\
\DIFaddFL{9  }&         \DIFaddFL{3   }\\
\DIFaddFL{11 }&    \DIFaddFL{58~393   }\\
\DIFaddFL{13 }&    \DIFaddFL{58~620   }\\
\DIFaddFL{16 }&         \DIFaddFL{1   }\\
\DIFaddFL{18 }&         \DIFaddFL{2   }\\
\textbf{\DIFaddFL{19}} &    \textbf{\DIFaddFL{26~286}}   \\
\DIFaddFL{23 }&         \DIFaddFL{1   }\\
\DIFaddFL{40 }&         \DIFaddFL{3   }\\
\end{tabular}
\label{tab:FreqAnalysis}
\end{table}
\DIFaddend 

%DIF <  \begin{figure*}[ht]
%DIF <      \centering
%DIF <      \includegraphics[width=1\textwidth]{03-dr-measured}
%DIF <      \caption{Measured data rate in [bps] in RS485 network during long-term operation test}
%DIF <      \label{fig:PacketLengthMeasuredAll}
%DIF <  \end{figure*}
\DIFaddbegin \begin{figure*}[ht]
    \centering
    \includegraphics[width=1\textwidth]{03-dr-measured}
    \caption{\DIFaddFL{Measured data rate in }[\DIFaddFL{bps}] \DIFaddFL{in RS485 network during long-term operation test}}
    \label{fig:PacketLengthMeasuredAll}
\end{figure*}
\DIFaddend 

% Based on the frequency analysis given in Tab.~\ref{tab:FreqAnalysis} and IMA know-how, 19 Bytes length packets transmit sensor data, and 7 Bytes length packets are general aknowledgemets of IMA protocol. At least two packets are required to handle sensor data via RS485 network, i.e., one carrying sensor data and the other with ackowledgement.

% %Fig. \ref{fig:PacketLengthMeasuredAll} shows 
% %Two imporatnt characteristics are displayed, maximal length of packet (red colored dash line) and median length of packet (red colored solid line). It is determined by frequency analysis method as shown in Tab. \ref{tab:FreqAnalysis}. Average RS485 network channel traffic load is 6.38 pps, i.e., 0.85 Bps.
% %shows lengths of captured packet  during
% %Median of packet length is determined by using frequency analysis method, as shown in Tab. \ref{tab:FreqAnalysis}.
% % 7,51 Byte --> simple arithmetic mean

% During long term operation test, lengths of transmitted packets ($ l $) are captured with the accuracy of timestamps of a thousandth of a second. Then resampled to one second resolution interval using the sum function to easily represent achieved data as a bit rate in bit per second (bps),
% Fig.~\ref{fig:PacketLengthMeasuredAll}.
% Red colored dashed line (with value of 2520~bps) shows one second time interval in which a sum of captured packets is transported in RS485 network. It shows, based on detailed knowledge of the IMA protocol, less than 20\% of the RS485 network capacity is used. 
% %This limit state is caused by data communication of two sensor nodes that occupied 2\% of capacity of used RS485 network.

% To avoid RS485 network congestion the maximum number of sensor nodes $ S_{MAX} $ can be calculated as:
% \begin{equation}
% S_{MAX} = \frac{\frac{\frac{v_{485}}{B}}{l_{MAX}} - R}{P}
% \label{equ:max-count-of-sensors}
% \end{equation}

% where:

% \begin{tabular}{l @{  } l}
% $v_{485}$ & 485 network data rate [bps]\\
%  B        & bits to Byte \\
% $l_{MAX}$ & maximal packet length \\
%  R        & reserve of the data rate [\%]\\
%  P        & number of packets to transmit sensor data \\
% \end{tabular}

% Considering above mentioned limits, desired reserves and RS485 data rates, the maximum number of sensor nodes simultaneously transmitting their data on RS485 network is calculated, Tab. \ref{tab:max-sensor-nodes}.

% Values for calculation are:

% \begin{tabular}{l @{ $=$ } l}
% $v_{485}$ & RS485 network data rate \\
%  B        & 8 \\
% $l_{MAX}$ & 40 \\
%  P        & 2 \\
% \end{tabular}

% % todo: this table makes error
% % \begin{table}[ht]
% % \centering
% % \footnotesize
% % \caption{Maximum number of sensor nodes simultaneously transmitting their data in RS485 network with desired reserve}
% % \begin{tabular}{r|rrrr}
% % \multicolumn{1}{c|}{\textbf{RS485}}     & \multicolumn{4}{c}{\multirow{2}{*}{\textbf{Reserve} $R$}}\\
% % \multicolumn{1}{c|}{\textbf{data rate}} &   \\
% % $v_{485}$ {[bps]}  &	0 \%	&	10 \%	&	20 \%	&	30 \%  \\ \hline
% %   1200~~~ &    1	&    1	&    1	&    1 \\
% %   2400~~~ &    3	&    3	&    3	&    2 \\
% %   4800~~~ &    7	&    6	&    6	&    5 \\
% %   9600~~~ &   15	&   13	&   12	&   10 \\
% %  19200~~~ &   30	&   27	&   24	&   21 \\
% %  38400~~~ &   60	&   54	&   48	&   42 \\
% %  57600~~~ &   90	&   81	&   72	&   63 \\
% % 115200~~~ &  180	&  162	&  144	&  126 \\
% % 230400~~~ &  360	&  324	&  288	&  252 \\
% % 460800~~~ &  720	&  648	&  576	&  504 \\
% % 921600~~~ & 1440	& 1296	& 1152	& 1008 \\
% % \end{tabular}
% % \label{tab:max-sensor-nodes}
% % \end{table}

% For example, WSN can connect up to 162 sensor nodes that work in RS485 network with a 115200~bps data rate and 10 \% reserve, or up to 126 sensor nodes with a 115200~bps data rate and 30 \% reserve. The results also show, one floor block of university building, i.e., one RS485 network, can operates dozens of sensors with sufficient reserve protecting the access control system from malfunction.   

















%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%       NOT USED
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The heavy traffic test simulates data transmission in the RS485 network as evidence of theoretically calculated values as shown in Tab \ref{tab:max-sensor-nodes}.

% \begin{figure}[!ht]
    % \centering
    % \includegraphics[width=.5\textwidth]{03-tp-simul}
    % \caption{RS485 datarates in simulation of heavy data traffic}
    % \label{fig:heavySimulation}
% \end{figure}

% This test simulated the transmission of more than 190~000 commands from 300 sensor nodes every 5 minutes simultaneously for 12 hours time period. The highest datarate achieved during simulation is 1160~bps, Fig \ref{fig:heavySimulation} red dashed line.

%!!! Tady to mozna chce frekvencni analyzu GW, at vis, jak jsou dlouhe pakety, pak nemusis hadat, nebo napis, ze max. delka je 19 bytů.

%Considering the worst case, ie packets with length of 40 Bytes, we have analytically calculated the maximum number of sensors a network can transmit based on the network transmission rate.

%\textbf{!!! Limit RS485: up to 32 transceivers on the serial bus !!! My vsak mame senzory pres LoRa ...Jo, ale to je fyzicky, to splnujeme, mame jich 13 :-)}
%datasheet: https://www.sparkfun.com/datasheets/Components/General/sp3485CN-LTR.pdf

%Space for peaks 10\% --> maximum packet rate is 324 pps
%Data measured in testing procedure shows Fig.

%\begin{table}[h]
%\centering
%\footnotesize
%\caption{Simple analytics of measured data}
%\begin{tabular}{lr}
%\textbf{Packet length} & \textbf{Bytes} \\ \hline
%Minimum   &   7 B     \\
%Maximum   &  40 B     \\
%mean      &   7,51 B  \\
%Median    &   7 B     \\
%\end{tabular}
%\label{tab: simple-analytics}
%\end{table}


%---
% tabulka, rezervy 10%, 30% ...
% Zjistit kolik sensoru muze byt na sbernici 485.
% popis os co  je co
